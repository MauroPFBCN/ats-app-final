<script>
// ---------- CONFIGURACIÓN ----------
const NOTION_DATABASE_ID = "e6cf390e4b8546e8a5e0d25eba52d598";
const NOTION_API_URL = "https://api.notion.com/v1";
// AQUÍ ESTÁ LA CORRECCIÓN: Se cambió "v1beta" por "v1"
const GEMINI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=";

// ---------- ELEMENTOS DEL DOM ----------
const tokenInput = document.getElementById('notion-token'), geminiKeyInput = document.getElementById('gemini-key'),
      languajeSearchInput = document.getElementById('languaje-search'),
      stageSelect = document.getElementById('dd-stage'), resolutionSelect = document.getElementById('dd-resolution'),
      statusSelect = document.getElementById('dd-status'), sourceSelect = document.getElementById('dd-source'),
      genderSelect = document.getElementById('dd-gender'), languajeSelect = document.getElementById('dd-languaje'),
      parseBtn = document.getElementById('parse-btn'), sendBtn = document.getElementById('send-btn'),
      messageBox = document.getElementById('message-box'), parsedDataSection = document.getElementById('parsed-data-section'),
      duplicateModal = document.getElementById('duplicate-modal'), modalText = document.getElementById('modal-text'),
      modalCancelBtn = document.getElementById('modal-cancel-btn'), modalConfirmBtn = document.getElementById('modal-confirm-btn'),
      dataFields = {
        name: document.getElementById('data-name'), email: document.getElementById('data-email'), phone: document.getElementById('data-phone'),
        location: document.getElementById('data-location'), linkedin: document.getElementById('data-linkedin'),
        company: document.getElementById('data-company'), skills: document.getElementById('data-skills'), 
        salary: document.getElementById('data-salary'),
      };

// ---------- LÓGICA PRINCIPAL ----------
document.addEventListener('DOMContentLoaded', () => {
    tokenInput.value = localStorage.getItem('notionApiToken') || '';
    geminiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
    if (tokenInput.value) loadDropdownData();
});
tokenInput.addEventListener('change', () => { localStorage.setItem('notionApiToken', tokenInput.value); loadDropdownData(); });
geminiKeyInput.addEventListener('change', () => localStorage.setItem('geminiApiKey', geminiKeyInput.value));
languajeSearchInput.addEventListener('keyup', () => {
    const filter = languajeSearchInput.value.toLowerCase();
    Array.from(languajeSelect.options).forEach(opt => {
        opt.style.display = opt.textContent.toLowerCase().includes(filter) ? "" : "none";
    });
});
document.getElementById('toggle-file').addEventListener('click', () => {
    document.getElementById('toggle-file').classList.add('active'); document.getElementById('toggle-url').classList.remove('active');
    document.getElementById('cv-file-input').style.display = 'block'; document.getElementById('cv-url-input').style.display = 'none';
});
document.getElementById('toggle-url').addEventListener('click', () => {
    document.getElementById('toggle-url').classList.add('active'); document.getElementById('toggle-file').classList.remove('active');
    document.getElementById('cv-url-input').style.display = 'block'; document.getElementById('cv-file-input').style.display = 'none';
});

function showMessage(type, text, duration = 0) {
    messageBox.className = `message ${type}`; messageBox.textContent = text;
    messageBox.style.display = 'block';
    if (duration > 0) setTimeout(() => { messageBox.style.display = 'none'; }, duration);
}

parseBtn.addEventListener('click', async () => {
    parseBtn.disabled = true; parseBtn.textContent = 'Analizando...'; sendBtn.disabled = true;
    showMessage('info', 'Iniciando análisis...');
    try {
        if (!geminiKeyInput.value) throw new Error('La Clave de API de Gemini es necesaria.');
        let contentToParse = '';
        if (document.getElementById('toggle-file').classList.contains('active')) {
            const file = document.getElementById('cv-file-input').files[0];
            if (!file) throw new Error('Por favor, selecciona un archivo PDF.');
            contentToParse = await extractTextFromPdf(file);
        } else {
            const url = document.getElementById('cv-url-input').value;
            if (!url) throw new Error('Por favor, introduce una URL.');
            contentToParse = `Extrae datos del perfil de LinkedIn: ${url}`;
        }
        showMessage('info', 'Contactando con la IA de Google...');
        const parsedData = await getAiParsedData(geminiKeyInput.value, contentToParse);
        populateFormFields(parsedData);
        parsedDataSection.style.display = 'block'; sendBtn.disabled = false;
        showMessage('success', 'Análisis completado. Revisa y edita los datos antes de enviar.', 5000);
    } catch (error) {
        showMessage('error', `Error en el análisis: ${error.message}`);
    } finally {
        parseBtn.disabled = false; parseBtn.textContent = '2. Analizar con IA';
    }
});

sendBtn.addEventListener('click', async () => {
    sendBtn.disabled = true;
    sendBtn.textContent = 'Verificando...';
    if (!dataFields.name.value) {
        showMessage('error', "El campo 'Nombre y Apellido' es obligatorio.");
        sendBtn.disabled = false; sendBtn.textContent = '3. Enviar a Notion';
        return;
    }
    const email = dataFields.email.value.trim();
    if (!email) { await proceedWithCreation(); return; }
    try {
        const duplicates = await findDuplicateByEmail(email);
        if (duplicates.length > 0) {
            const existing = duplicates[0];
            const name = existing.properties["Nombre y Apellido"].title[0].plain_text;
            const url = existing.url;
            showDuplicateModal(name, url);
        } else { await proceedWithCreation(); }
    } catch (error) {
        showMessage('error', `Error al verificar duplicados: ${error.message}`);
        sendBtn.disabled = false; sendBtn.textContent = '3. Enviar a Notion';
    }
});

async function proceedWithCreation() {
    sendBtn.textContent = 'Enviando...';
    try {
        const newPage = await createNotionEntry();
        showMessage('success', '¡Candidato creado con éxito!', 3000);
        if (newPage && newPage.url) window.open(newPage.url, '_blank');
    } catch (error) {
        showMessage('error', `Error al enviar a Notion: ${error.message}`);
    } finally {
        sendBtn.disabled = false; sendBtn.textContent = '3. Enviar a Notion';
    }
}
modalCancelBtn.addEventListener('click', () => {
    duplicateModal.style.display = 'none';
    sendBtn.disabled = false; sendBtn.textContent = '3. Enviar a Notion';
});
modalConfirmBtn.addEventListener('click', async () => {
    duplicateModal.style.display = 'none';
    await proceedWithCreation();
});
function showDuplicateModal(name, url) {
    modalText.innerHTML = `Ya existe un registro con este email a nombre de: <br><strong><a href="${url}" target="_blank">${name}</a></strong>`;
    duplicateModal.style.display = 'flex';
}

function populateFormFields(data) {
    Object.keys(data).forEach(key => {
        if (key === 'skills_breakdown') {
            let allSkills = [];
            const { job_titles = [], programming_languages = [], frameworks_libraries = [], databases = [] } = data.skills_breakdown;
            allSkills = [...job_titles, ...programming_languages, ...frameworks_libraries, ...databases];
            dataFields.skills.value = [...new Set(allSkills)].join(', ');
        } else if (dataFields[key]) {
            let value = data[key];
            if (key === 'phone') value = (value || '').replace(/[\s.-]/g, '');
            if (key === 'salary' && dataFields.salary.value) return;
            dataFields[key].value = value || '';
        }
    });
}

async function extractTextFromPdf(file) {
    const reader = new FileReader();
    return new Promise((resolve, reject) => {
        reader.onload = async (event) => {
            try {
                const pdf = await pdfjsLib.getDocument(event.target.result).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ');
                }
                resolve(fullText);
            } catch (error) { reject(new Error('No se pudo leer el archivo PDF.')); }
        };
        reader.onerror = () => reject(new Error('Error al leer el archivo.'));
        reader.readAsArrayBuffer(file);
    });
}

// ---------- COMUNICACIÓN CON APIS (A TRAVÉS DEL PROXY PRIVADO) ----------
async function callApiProxy(targetUrl, method, apiHeaders, body = null) {
    const response = await fetch('/api/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: targetUrl, method, headers: apiHeaders, body })
    });

    const responseBodyText = await response.text();

    if (!response.ok) {
        throw new Error(`Error del Proxy (${response.status}): ${responseBodyText}`);
    }

    try {
        return JSON.parse(responseBodyText);
    } catch (e) {
        throw new Error("El proxy devolvió una respuesta exitosa, pero no era un JSON válido.");
    }
}

async function getAiParsedData(apiKey, cvText) {
    const prompt = `Eres un asistente de RRHH experto. Analiza el CV y devuelve un JSON con esta estructura exacta. Si un campo no se encuentra, déjalo como un string vacío "" o un array vacío []. { "name": "string", "email": "string", "phone": "string; formato +codigopaisNUMERO, sin espacios", "location": "string; solo 'Ciudad, País'", "linkedin": "string; si es un hipervínculo, extrae la URL", "company": "string", "salary": "string", "skills_breakdown": { "job_titles": ["string", "Array con MÁXIMO 1 o 2 TÍTULOS DE PUESTO GENERALIZADOS. Analiza los puestos recientes y resúmelos en un término genérico (ej: 'Software Development')."], "programming_languages": ["string", "Array con MÁXIMO 3 lenguajes de programación principales."], "frameworks_libraries": ["string", "Array con MÁXIMO 3 frameworks o librerías principales."], "databases": ["string", "Array con MÁXIMO 1 base de datos principal."] } } CV: --- ${cvText} ---`;
    const payload = { contents: [{ parts: [{ text: prompt }] }] };
    const data = await callApiProxy(GEMINI_API_URL_BASE + apiKey, 'POST', {}, payload);
    if (!data.candidates) {
        console.error("Respuesta de IA inesperada:", data);
        if (data.promptFeedback && data.promptFeedback.blockReason) {
            throw new Error(`La IA bloqueó la respuesta. Razón: ${data.promptFeedback.blockReason}`);
        }
        throw new Error("La IA devolvió una respuesta inesperada.");
    }
    const textResponse = data.candidates[0].content.parts[0].text;
    const jsonMatch = textResponse.match(/```json\n([\s\S]*?)\n```/);
    if (!jsonMatch) {
        console.error("Respuesta completa de la IA que causó el error:", textResponse);
        throw new Error("La IA no devolvió un JSON válido. Revisa la consola (Ctrl+Shift+I) para ver la respuesta completa.");
    }
    return JSON.parse(jsonMatch[1]);
}

async function loadDropdownData() {
    showMessage('info', 'Cargando datos de Notion...');
    try {
        const headers = { 'Authorization': `Bearer ${tokenInput.value}`, 'Notion-Version': '2022-06-28' };
        const dbInfo = await callApiProxy(`${NOTION_API_URL}/databases/${NOTION_DATABASE_ID}`, 'GET', headers);
        const populate = (pName, el) => {
            if (!el) { console.error(`Elemento del DOM no encontrado: ${pName}`); return; }
            const prop = dbInfo.properties[pName];
            if (prop) { const opts = prop.select?.options || prop.multi_select?.options || prop.status?.options; if (opts) populateSelect(el, opts, pName); }
        };
        ['STAGE', 'RESOLUTION', 'Status', 'SOURCE', 'Gender', 'LANGUAJE'].forEach(p => populate(p, document.getElementById(`dd-${p.toLowerCase()}`)));
        showMessage('success', 'Datos de Notion cargados.', 3000);
    } catch (error) { showMessage('error', `No se pudieron cargar los datos de Notion: ${error.message}`); }
}

function populateSelect(selectElement, options, propertyName) {
    selectElement.innerHTML = '';
    if (propertyName !== 'LANGUAJE') { /* No ordenar */ } 
    else { options.sort((a, b) => { /* Orden para idiomas */
            const nameA = a.name.toLowerCase(), nameB = b.name.toLowerCase(); let pA = 2, pB = 2;
            if (nameA.startsWith('english')) pA = 0; else if (nameA.startsWith('spanish')) pA = 1;
            if (nameB.startsWith('english')) pB = 0; else if (nameB.startsWith('spanish')) pB = 1;
            if (pA !== pB) return pA - pB; return nameA.localeCompare(nameB);
        });
    }
    if (!selectElement.multiple) {
        selectElement.innerHTML = '<option value=""></option>';
    }
    options.forEach(opt => { const o = document.createElement('option'); o.value = opt.name; o.textContent = opt.name; selectElement.appendChild(o); });
}

async function findDuplicateByEmail(email) {
    const headers = { 'Authorization': `Bearer ${tokenInput.value}`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' };
    const body = { filter: { property: 'Email', email: { equals: email } } };
    const response = await callApiProxy(`${NOTION_API_URL}/databases/${NOTION_DATABASE_ID}/query`, 'POST', headers, body);
    return response.results;
}

async function createNotionEntry() {
    const properties = { "Nombre y Apellido": { title: [{ text: { content: dataFields.name.value } }] } };
    let linkedInUrl = dataFields.linkedin.value.trim();
    if (linkedInUrl && !linkedInUrl.startsWith('http')) {
        linkedInUrl = `https://www.linkedin.com/in/${linkedInUrl.replace(/^\//, '')}`;
    }
    const addSelect = (pName, el) => { if (el.value) properties[pName] = { select: { name: el.value } }; };
    ['STAGE', 'RESOLUTION', 'SOURCE', 'Gender'].forEach(p => addSelect(p, document.getElementById(`dd-${p.toLowerCase()}`)));
    if (statusSelect.value) properties.Status = { status: { name: statusSelect.value } };
    const selectedLangs = Array.from(languajeSelect.options).filter(o => o.selected).map(o => ({ name: o.value }));
    if (selectedLangs.length > 0) properties.LANGUAJE = { multi_select: selectedLangs };
    const phoneVal = dataFields.phone.value.replace(/[\s.-]/g, '');
    if (phoneVal) properties.Phone = { phone_number: phoneVal };
    const addRichText = (pName, field) => { if (field.value) properties[pName] = { rich_text: [{ text: { content: field.value } }] }; };
    addRichText('LOCATION', dataFields.location);
    addRichText('CURRENT COMPANY', dataFields.company);
    addRichText('SALARY EXPECTATION', dataFields.salary);
    if (dataFields.email.value) properties.Email = { email: dataFields.email.value };
    if (linkedInUrl) properties["LINKEDIN URL"] = { url: linkedInUrl };
    if (dataFields.skills.value) properties.Skills = { multi_select: dataFields.skills.value.split(',').map(s => ({ name: s.trim() })).filter(s => s.name) };
    const headers = { 'Authorization': `Bearer ${tokenInput.value}`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' };
    return await callApiProxy(`${NOTION_API_URL}/pages`, 'POST', headers, { parent: { database_id: NOTION_DATABASE_ID }, properties });
}
</script>
